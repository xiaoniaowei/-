//获取Excel的音乐列表
        public ActionResult GetMusicList(layuitablepage laypage,int? ListType)
        {
            string url = Server.MapPath("~/Document/音乐列表.xlsx");
            layuitabledata<GetMusicData> table = new layuitabledata<GetMusicData>();
            if (System.IO.File.Exists(url))
            {
                IWorkbook wokerbook;
                using (FileStream fs = new FileStream(url, FileMode.Open, FileAccess.Read))
                {
                    wokerbook = new XSSFWorkbook(fs);
                    fs.Close();
                }
                ISheet sheet = wokerbook.GetSheetAt(0);
                DataTable dtTable = new DataTable();
                IRow headrow = sheet.GetRow(0);
                int allcol = headrow.LastCellNum;
                int allrow = sheet.LastRowNum + 1;
                for (int i = headrow.FirstCellNum; i < allcol; i++)
                {
                    DataColumn dtcolumn = new DataColumn(headrow.GetCell(i).StringCellValue);
                    dtTable.Columns.Add(dtcolumn);
                }
                for (int i = sheet.FirstRowNum + 1; i < allrow; i++)
                {
                    IRow row = sheet.GetRow(i);
                    DataRow dtrow = dtTable.NewRow();
                    if (row != null)
                    {
                        bool isnull = true;
                        for (int j = row.FirstCellNum; j < allcol; j++)
                        {
                            if (row.GetCell(j) != null)
                            {
                                row.GetCell(j).SetCellType(CellType.String);
                                string cellval = row.GetCell(j).StringCellValue;
                                dtrow[j] = cellval;
                                if (!string.IsNullOrEmpty(cellval))
                                {
                                    isnull = false;
                                }
                            }
                        }
                        if (!isnull)
                        {
                            dtTable.Rows.Add(dtrow);
                        }
                    }
                }
                List<GetMusicData> MusicList = new List<GetMusicData>();
                for (int i = 0; i < dtTable.Rows.Count; i++)
                {
                    GetMusicData Music = new GetMusicData();
                    DataRow rows = dtTable.Rows[i];
                    Music.MusicName = rows[0].ToString();
                    Music.MusicType = rows[1].ToString();
                    Music.Singer = rows[2].ToString();
                    Music.LoveMusic = Convert.ToBoolean(rows[3]);
                    Music.StoreMusic = Convert.ToBoolean(rows[4]);
                    Music.MusicUrl = rows[5].ToString();
                    Music.ImportTime = rows[6].ToString();
                    MusicList.Add(Music);
                }
                int listcount = MusicList.Count();
                if (ListType != 0&& ListType!=null)
                {
                    if (ListType == 1)
                    {
                        MusicList = MusicList.Where(m => m.LoveMusic == true).ToList();
                    }
                    if (ListType == 2)
                    {
                        MusicList = MusicList.Where(m => m.StoreMusic == true).ToList();
                    }
                }
                else
                {
                    MusicList = MusicList.Where(m => m.RecoveryMusic == false).ToList();
                }
                MusicList = MusicList.Skip(laypage.GetStartIndex()).Take(laypage.limit).ToList();
                table.count = listcount;
                table.data = MusicList;
            }
            else
            {
                table.count = 0;
                table.data = null;
            }
            return Json(table, JsonRequestBehavior.AllowGet);
        }
        public ActionResult GetRmMusicList(layuitablepage laypage)
        {
            string url = Server.MapPath("~/Document/回收列表.xlsx");
            layuitabledata<GetMusicData> table = new layuitabledata<GetMusicData>();
            if (System.IO.File.Exists(url))
            {
                IWorkbook wokerbook;
                using (FileStream fs = new FileStream(url, FileMode.Open, FileAccess.Read))
                {
                    wokerbook = new XSSFWorkbook(fs);
                    fs.Close();
                }
                ISheet sheet = wokerbook.GetSheetAt(0);
                DataTable dtTable = new DataTable();
                IRow headrow = sheet.GetRow(0);
                int allcol = headrow.LastCellNum;
                int allrow = sheet.LastRowNum + 1;
                for (int i = headrow.FirstCellNum; i < allcol; i++)
                {
                    DataColumn dtcolumn = new DataColumn(headrow.GetCell(i).StringCellValue);
                    dtTable.Columns.Add(dtcolumn);
                }
                for (int i = sheet.FirstRowNum + 1; i < allrow; i++)
                {
                    IRow row = sheet.GetRow(i);
                    DataRow dtrow = dtTable.NewRow();
                    if (row != null)
                    {
                        bool isnull = true;
                        for (int j = row.FirstCellNum; j < allcol; j++)
                        {
                            if (row.GetCell(j) != null)
                            {
                                row.GetCell(j).SetCellType(CellType.String);
                                string cellval = row.GetCell(j).StringCellValue;
                                dtrow[j] = cellval;
                                if (!string.IsNullOrEmpty(cellval))
                                {
                                    isnull = false;
                                }
                            }
                        }
                        if (!isnull)
                        {
                            dtTable.Rows.Add(dtrow);
                        }
                    }
                }
                List<GetMusicData> MusicList = new List<GetMusicData>();
                for (int i = 0; i < dtTable.Rows.Count; i++)
                {
                    GetMusicData Music = new GetMusicData();
                    DataRow rows = dtTable.Rows[i];
                    Music.MusicName = rows[0].ToString();
                    Music.MusicType = rows[1].ToString();
                    Music.Singer = rows[2].ToString();
                    Music.LoveMusic = Convert.ToBoolean(rows[3]);
                    Music.StoreMusic = Convert.ToBoolean(rows[4]);
                    Music.MusicUrl = rows[5].ToString();
                    Music.ImportTime = rows[6].ToString();
                    MusicList.Add(Music);
                }
                int listcount = MusicList.Count();
                MusicList = MusicList.Skip(laypage.GetStartIndex()).Take(laypage.limit).ToList();
                table.count = listcount;
                table.data = MusicList;
            }
            else
            {
                table.count = 0;
                table.data = null;
            }
            return Json(table, JsonRequestBehavior.AllowGet);
        }
        //获取Excel中的所有音乐
        public ActionResult MusicList(int? ListType)
        {
            string url = Server.MapPath("~/Document/音乐列表.xlsx");
            if (System.IO.File.Exists(url))
            {
                IWorkbook wokerbook;
                using (FileStream fs = new FileStream(url, FileMode.Open, FileAccess.Read))
                {
                    wokerbook = new XSSFWorkbook(fs);
                    fs.Close();
                }
                ISheet sheet = wokerbook.GetSheetAt(0);
                DataTable dtTable = new DataTable();
                IRow headrow = sheet.GetRow(0);
                int allcol = headrow.LastCellNum;
                int allrow = sheet.LastRowNum + 1;
                for (int i = headrow.FirstCellNum; i < allcol; i++)
                {
                    DataColumn dtcolumn = new DataColumn(headrow.GetCell(i).StringCellValue);
                    dtTable.Columns.Add(dtcolumn);
                }
                for (int i = sheet.FirstRowNum + 1; i < allrow; i++)
                {
                    IRow row = sheet.GetRow(i);
                    DataRow dtrow = dtTable.NewRow();
                    if (row != null)
                    {
                        bool isnull = true;
                        for (int j = row.FirstCellNum; j < allcol; j++)
                        {
                            if (row.GetCell(j) != null)
                            {
                                row.GetCell(j).SetCellType(CellType.String);
                                string cellval = row.GetCell(j).StringCellValue;
                                dtrow[j] = cellval;
                                if (!string.IsNullOrEmpty(cellval))
                                {
                                    isnull = false;
                                }
                            }
                        }
                        if (!isnull)
                        {
                            dtTable.Rows.Add(dtrow);
                        }
                    }
                }
                List<GetMusicData> MusicList = new List<GetMusicData>();
                for (int i = 0; i < dtTable.Rows.Count; i++)
                {
                    GetMusicData Music = new GetMusicData();
                    DataRow rows = dtTable.Rows[i];
                    Music.MusicName = rows[0].ToString();
                    Music.MusicType = rows[1].ToString();
                    Music.Singer = rows[2].ToString();
                    Music.LoveMusic = Convert.ToBoolean(rows[3]);
                    Music.StoreMusic = Convert.ToBoolean(rows[4]);
                    Music.MusicUrl = rows[5].ToString();
                    Music.ImportTime = rows[6].ToString();
                    MusicList.Add(Music);
                }
                if (ListType != 0 && ListType != null)
                {
                    if (ListType == 1)
                    {
                        MusicList = MusicList.Where(m => m.LoveMusic == true).ToList();
                    }
                    if (ListType == 2)
                    {
                        MusicList = MusicList.Where(m => m.StoreMusic == true).ToList();
                    }
                }
                else
                {
                    MusicList = MusicList.Where(m => m.RecoveryMusic == false).ToList();
                }
                return Json(MusicList, JsonRequestBehavior.AllowGet);
            }
            else
            {
                return Json("请导入文件", JsonRequestBehavior.AllowGet);
            }
        }
        public ActionResult RmMusicList()
        {
            string url = Server.MapPath("~/Document/回收列表.xlsx");
            if (System.IO.File.Exists(url))
            {
                IWorkbook wokerbook;
                using (FileStream fs = new FileStream(url, FileMode.Open, FileAccess.Read))
                {
                    wokerbook = new XSSFWorkbook(fs);
                    fs.Close();
                }
                ISheet sheet = wokerbook.GetSheetAt(0);
                DataTable dtTable = new DataTable();
                IRow headrow = sheet.GetRow(0);
                int allcol = headrow.LastCellNum;
                int allrow = sheet.LastRowNum + 1;
                for (int i = headrow.FirstCellNum; i < allcol; i++)
                {
                    DataColumn dtcolumn = new DataColumn(headrow.GetCell(i).StringCellValue);
                    dtTable.Columns.Add(dtcolumn);
                }
                for (int i = sheet.FirstRowNum + 1; i < allrow; i++)
                {
                    IRow row = sheet.GetRow(i);
                    DataRow dtrow = dtTable.NewRow();
                    if (row != null)
                    {
                        bool isnull = true;
                        for (int j = row.FirstCellNum; j < allcol; j++)
                        {
                            if (row.GetCell(j) != null)
                            {
                                row.GetCell(j).SetCellType(CellType.String);
                                string cellval = row.GetCell(j).StringCellValue;
                                dtrow[j] = cellval;
                                if (!string.IsNullOrEmpty(cellval))
                                {
                                    isnull = false;
                                }
                            }
                        }
                        if (!isnull)
                        {
                            dtTable.Rows.Add(dtrow);
                        }
                    }
                }
                List<GetMusicData> MusicList = new List<GetMusicData>();
                for (int i = 0; i < dtTable.Rows.Count; i++)
                {
                    GetMusicData Music = new GetMusicData();
                    DataRow rows = dtTable.Rows[i];
                    Music.MusicName = rows[0].ToString();
                    Music.MusicType = rows[1].ToString();
                    Music.Singer = rows[2].ToString();
                    Music.LoveMusic = Convert.ToBoolean(rows[3]);
                    Music.StoreMusic = Convert.ToBoolean(rows[4]);
                    Music.MusicUrl = rows[5].ToString();
                    Music.ImportTime = rows[6].ToString();
                    MusicList.Add(Music);
                }
                return Json(MusicList, JsonRequestBehavior.AllowGet);
            }
            else
            {
                return Json("请导入文件", JsonRequestBehavior.AllowGet);
            }
        }
        //读取路径下的所有文件的名称,上传到数据库
        public ActionResult AddPath(string MusicPath)
        {
            var has = System.IO.Directory.Exists(MusicPath);
            if (has)
            {
                var files = Directory.GetFiles(MusicPath);
                string MusicName = Server.MapPath("~/Document/音乐列表.xlsx");
                string MusicPathurl = Server.MapPath("~/Document/音乐路径列表.xlsx");
                if (!System.IO.File.Exists(MusicPathurl))
                {
                    IWorkbook wb = new XSSFWorkbook();
                    ISheet st = wb.CreateSheet("MusicPath");
                    IRow hrow = st.CreateRow(0);
                    hrow.CreateCell(0).SetCellValue("路径");
                    using(FileStream fs=new FileStream(MusicPathurl, FileMode.Create, FileAccess.Write))
                    {
                        wb.Write(fs);
                        fs.Close();
                    }
                }
                if (!System.IO.File.Exists(MusicName))
                {
                    IWorkbook wb = new XSSFWorkbook();
                    ISheet st = wb.CreateSheet("MusicName");
                    IRow hrow = st.CreateRow(0);
                    string[] keyname = new string[] { "音乐名称", "格式", "歌手", "喜欢", "收藏", "路径", "写入时间","路径ID" };
                    for (int i = 0; i < keyname.Length; i++)
                    {
                        hrow.CreateCell(i).SetCellValue(keyname[i]);
                    }
                    using (FileStream fs = new FileStream(MusicName, FileMode.Create, FileAccess.Write))
                    {
                        wb.Write(fs);
                        fs.Close();
                    }
                }
                if (files.Length > 0)
                {
                    #region 把路径存入文件
                    IWorkbook PathBook;
                    using (FileStream pathfile = new FileStream(MusicPathurl, FileMode.Open, FileAccess.Read))
                    {
                        PathBook = new XSSFWorkbook(pathfile);
                        pathfile.Close();
                    }
                    ISheet Pathsheet = PathBook.GetSheetAt(0);
                    int Pathallrow = Pathsheet.LastRowNum;
                    bool haspath=false;
                    int PathID=0;
                    //是否已存在
                    if (Pathallrow > 0)
                    {
                        for (int j = 1; j < (Pathallrow+1); j++)
                        {
                            string thepath = Pathsheet.GetRow(j).GetCell(0).StringCellValue;
                            if (MusicPath == thepath)
                            {
                                haspath = true;
                                PathID = j;
                                break;
                            }
                        }
                    }
                    if (!haspath)
                    {
                        IRow Pathrow = Pathsheet.CreateRow(Pathallrow + 1);
                        Pathrow.CreateCell(0).SetCellValue(MusicPath);
                        using (FileStream pathfile = new FileStream(MusicPathurl, FileMode.Create, FileAccess.Write))
                        {
                            PathBook.Write(pathfile);
                            pathfile.Close();
                        }
                    }
                    #endregion
                    #region 把音乐信息存入文件
                    IWorkbook MusicBook;
                    using(FileStream musicfile=new FileStream(MusicName, FileMode.Open, FileAccess.Read))
                    {
                        MusicBook = new XSSFWorkbook(musicfile);
                        musicfile.Close();
                    }
                    ISheet MusicSheet = MusicBook.GetSheetAt(0);
                    int allrow = MusicSheet.LastRowNum + 1;
                    //如果是更新,那么则把原文件信息全删
                    if (haspath)
                    {
                        Pathallrow = PathID - 1;
                        for (int k = 1; k < (MusicSheet.LastRowNum+1); k++)
                        {
                            double Rmrow = MusicSheet.GetRow(k).GetCell(8).NumericCellValue;
                            IRow row = MusicSheet.GetRow(k);
                            if (PathID == Rmrow)
                            {
                                MusicSheet.RemoveRow(row);
                            }
                        }
                    }
                    for (int j = allrow; j < files.Length; j++)
                    {
                        IRow dtrow = MusicSheet.CreateRow(j);
                        string[] Musicname = files[j-1].Replace(MusicPath + "\\", "").Split('-');
                        dtrow.CreateCell(0).SetCellValue(Musicname[1]);
                        dtrow.CreateCell(1).SetCellValue(".MP3");
                        dtrow.CreateCell(2).SetCellValue(Musicname[0]);
                        dtrow.CreateCell(3).SetCellValue(false);
                        dtrow.CreateCell(4).SetCellValue(false);
                        dtrow.CreateCell(5).SetCellValue(files[j-1]);
                        dtrow.CreateCell(6).SetCellValue(DateTime.Now.ToString("yyyy-MM-dd"));
                        dtrow.CreateCell(7).SetCellValue(Pathallrow + 1);
                    }
                    using (FileStream musicfile = new FileStream(MusicName, FileMode.Create, FileAccess.Write))
                    {
                        MusicBook.Write(musicfile);
                        musicfile.Close();
                    }
                    #endregion
                    return Json("写入成功", JsonRequestBehavior.AllowGet);

                }
                else
                {
                    return Json("该文件夹下没有文件", JsonRequestBehavior.AllowGet);
                }
            }
            else
            {
                return Json("不存在该路径",JsonRequestBehavior.AllowGet);
            }
        }
        //将文件读取为二进制流返回
        public ActionResult BlackByte(string strPath)
        {
            FileStream fs = new FileStream(strPath,FileMode.Open);
            BinaryReader br = new BinaryReader(fs);
            byte[] bytes = br.ReadBytes((int)fs.Length);
            fs.Close();
            fs.Dispose();
            return File(bytes, "application/octet-stream");
        }
        //改变音乐的状态，被喜欢--被收藏--被移除
        public ActionResult MusicState(bool State, string Type,int Rowindex)
        {
            string Musiclist = Server.MapPath("~/Document/音乐列表.xlsx");
            string RmMusicList = Server.MapPath("~/Document/回收列表.xlsx");
            IWorkbook musicbook;
            using (FileStream fs = new FileStream(Musiclist, FileMode.Open, FileAccess.Read))
            {
                musicbook = new XSSFWorkbook(fs);
                fs.Close();
            }
            ISheet sheet = musicbook.GetSheetAt(0);
            if (Type == "love")
            {
                sheet.GetRow(Rowindex).GetCell(3).SetCellValue(State);
            }
            if (Type == "store")
            {
                sheet.GetRow(Rowindex).GetCell(4).SetCellValue(State);
            }
            if (Type == "recovery")
            {
                IRow rmrow = sheet.GetRow(Rowindex);
                if (!System.IO.File.Exists(RmMusicList))
                {
                    IWorkbook rmlist = new XSSFWorkbook();
                    ISheet rmsheet = rmlist.CreateSheet("rmMusic");
                    IRow headrow = rmsheet.CreateRow(0);
                    string[] keyname = new string[] { "音乐名称", "格式", "歌手", "喜欢", "收藏","路径", "写入时间", "路径ID" };
                    for (int i = 0; i < keyname.Length; i++)
                    {
                        headrow.CreateCell(i).SetCellValue(keyname[i]);
                    }
                    using(FileStream fs=new FileStream(RmMusicList, FileMode.Create, FileAccess.Write))
                    {
                        rmlist.Write(fs);
                        fs.Close();
                    }
                }
                IWorkbook rmbook;
                using (FileStream fs = new FileStream(RmMusicList, FileMode.Open, FileAccess.Read))
                {
                    rmbook = new XSSFWorkbook(fs);
                    fs.Close();
                }
                ISheet removesheet = rmbook.GetSheetAt(0);
                int allrow = removesheet.LastRowNum+1;
                IRow dtrow = removesheet.CreateRow(allrow);
                dtrow.CreateCell(0).SetCellValue(rmrow.GetCell(0).StringCellValue);
                dtrow.CreateCell(1).SetCellValue(rmrow.GetCell(1).StringCellValue);
                dtrow.CreateCell(2).SetCellValue(rmrow.GetCell(2).StringCellValue);
                dtrow.CreateCell(3).SetCellValue(rmrow.GetCell(3).BooleanCellValue);
                dtrow.CreateCell(4).SetCellValue(rmrow.GetCell(4).BooleanCellValue);
                dtrow.CreateCell(5).SetCellValue(rmrow.GetCell(5).StringCellValue);
                dtrow.CreateCell(6).SetCellValue(rmrow.GetCell(6).StringCellValue);
                dtrow.CreateCell(7).SetCellValue(rmrow.GetCell(7).NumericCellValue);
                using (FileStream fs = new FileStream(RmMusicList, FileMode.Create, FileAccess.Write))
                {
                    rmbook.Write(fs);
                    fs.Close();
                }
                sheet.ShiftRows(Rowindex+1, sheet.LastRowNum, -1);
            }
            using (FileStream fs = new FileStream(Musiclist, FileMode.Create, FileAccess.Write))
            {
                musicbook.Write(fs);
                fs.Close();
            }
            return Json("修改成功", JsonRequestBehavior.AllowGet);
        }
